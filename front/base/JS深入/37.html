<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise | 黑豆的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="黑豆的博客">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.7dcbcc26.css" as="style"><link rel="preload" href="/assets/js/app.99d8b2e7.js" as="script"><link rel="preload" href="/assets/js/2.3eedf0cf.js" as="script"><link rel="preload" href="/assets/js/1.461a0297.js" as="script"><link rel="preload" href="/assets/js/244.6baa3c2c.js" as="script"><link rel="preload" href="/assets/js/80.57c199e7.js" as="script"><link rel="prefetch" href="/assets/js/10.a8fd5793.js"><link rel="prefetch" href="/assets/js/100.44c8bd82.js"><link rel="prefetch" href="/assets/js/101.bb1c58b4.js"><link rel="prefetch" href="/assets/js/102.96141f72.js"><link rel="prefetch" href="/assets/js/103.af0c3823.js"><link rel="prefetch" href="/assets/js/104.35ed8635.js"><link rel="prefetch" href="/assets/js/105.708b89c0.js"><link rel="prefetch" href="/assets/js/106.20f03bca.js"><link rel="prefetch" href="/assets/js/107.faf5cc02.js"><link rel="prefetch" href="/assets/js/108.cb76a6bc.js"><link rel="prefetch" href="/assets/js/109.126e9cb6.js"><link rel="prefetch" href="/assets/js/11.6ec6a70f.js"><link rel="prefetch" href="/assets/js/110.ee155398.js"><link rel="prefetch" href="/assets/js/111.7cd01b2a.js"><link rel="prefetch" href="/assets/js/112.05534a62.js"><link rel="prefetch" href="/assets/js/113.8fce6fb1.js"><link rel="prefetch" href="/assets/js/114.5296ad64.js"><link rel="prefetch" href="/assets/js/115.256be922.js"><link rel="prefetch" href="/assets/js/116.3f4369e1.js"><link rel="prefetch" href="/assets/js/117.2142f60b.js"><link rel="prefetch" href="/assets/js/118.d0b314d1.js"><link rel="prefetch" href="/assets/js/119.b3dbbbba.js"><link rel="prefetch" href="/assets/js/12.47bc3be3.js"><link rel="prefetch" href="/assets/js/120.bc8cfbe9.js"><link rel="prefetch" href="/assets/js/121.949ef6c9.js"><link rel="prefetch" href="/assets/js/122.7c4f8f02.js"><link rel="prefetch" href="/assets/js/123.38ea12a6.js"><link rel="prefetch" href="/assets/js/124.f03975d1.js"><link rel="prefetch" href="/assets/js/125.7d45e38a.js"><link rel="prefetch" href="/assets/js/126.fe53a61c.js"><link rel="prefetch" href="/assets/js/127.8d0fb240.js"><link rel="prefetch" href="/assets/js/128.eb9131d8.js"><link rel="prefetch" href="/assets/js/129.6287c5aa.js"><link rel="prefetch" href="/assets/js/13.6a3faa3d.js"><link rel="prefetch" href="/assets/js/130.594a5f95.js"><link rel="prefetch" href="/assets/js/131.a25d9997.js"><link rel="prefetch" href="/assets/js/132.de9b2246.js"><link rel="prefetch" href="/assets/js/133.56ceefbb.js"><link rel="prefetch" href="/assets/js/134.0036f7d9.js"><link rel="prefetch" href="/assets/js/135.922f03c6.js"><link rel="prefetch" href="/assets/js/136.6ec3bf33.js"><link rel="prefetch" href="/assets/js/137.278bd239.js"><link rel="prefetch" href="/assets/js/138.05015bd3.js"><link rel="prefetch" href="/assets/js/139.4b37d910.js"><link rel="prefetch" href="/assets/js/14.dd3258aa.js"><link rel="prefetch" href="/assets/js/140.26ac508e.js"><link rel="prefetch" href="/assets/js/141.04d71e20.js"><link rel="prefetch" href="/assets/js/142.13d7d63c.js"><link rel="prefetch" href="/assets/js/143.46ad857e.js"><link rel="prefetch" href="/assets/js/144.80a2092f.js"><link rel="prefetch" href="/assets/js/145.e61d2536.js"><link rel="prefetch" href="/assets/js/146.94fcfb9f.js"><link rel="prefetch" href="/assets/js/147.193c9275.js"><link rel="prefetch" href="/assets/js/148.461d82f0.js"><link rel="prefetch" href="/assets/js/149.c6e43ff5.js"><link rel="prefetch" href="/assets/js/15.0a2d01b1.js"><link rel="prefetch" href="/assets/js/150.6c48a8d0.js"><link rel="prefetch" href="/assets/js/151.22a14608.js"><link rel="prefetch" href="/assets/js/152.f5e46bbb.js"><link rel="prefetch" href="/assets/js/153.3f13394c.js"><link rel="prefetch" href="/assets/js/154.d05e648e.js"><link rel="prefetch" href="/assets/js/155.2bb1659a.js"><link rel="prefetch" href="/assets/js/156.64d39ba1.js"><link rel="prefetch" href="/assets/js/157.3cdf9604.js"><link rel="prefetch" href="/assets/js/158.87e2f807.js"><link rel="prefetch" href="/assets/js/159.7503cb20.js"><link rel="prefetch" href="/assets/js/16.42369fc4.js"><link rel="prefetch" href="/assets/js/160.55c8a8b4.js"><link rel="prefetch" href="/assets/js/161.3e0fe81d.js"><link rel="prefetch" href="/assets/js/162.83297e1e.js"><link rel="prefetch" href="/assets/js/163.3e9e440c.js"><link rel="prefetch" href="/assets/js/164.d8da7753.js"><link rel="prefetch" href="/assets/js/165.1af15093.js"><link rel="prefetch" href="/assets/js/166.355e64b4.js"><link rel="prefetch" href="/assets/js/167.3a93b460.js"><link rel="prefetch" href="/assets/js/168.093d8a10.js"><link rel="prefetch" href="/assets/js/169.7783dd31.js"><link rel="prefetch" href="/assets/js/17.2e4bed97.js"><link rel="prefetch" href="/assets/js/170.323d14f0.js"><link rel="prefetch" href="/assets/js/171.2dca02c2.js"><link rel="prefetch" href="/assets/js/172.2113837e.js"><link rel="prefetch" href="/assets/js/173.0880ed96.js"><link rel="prefetch" href="/assets/js/174.21e41c8d.js"><link rel="prefetch" href="/assets/js/175.24057138.js"><link rel="prefetch" href="/assets/js/176.5b75c1f2.js"><link rel="prefetch" href="/assets/js/177.1117a387.js"><link rel="prefetch" href="/assets/js/178.f861ee85.js"><link rel="prefetch" href="/assets/js/179.b994ee8c.js"><link rel="prefetch" href="/assets/js/18.5180f4f8.js"><link rel="prefetch" href="/assets/js/180.c0c010cf.js"><link rel="prefetch" href="/assets/js/181.e984d119.js"><link rel="prefetch" href="/assets/js/182.f8bf953f.js"><link rel="prefetch" href="/assets/js/183.9859029a.js"><link rel="prefetch" href="/assets/js/184.dfcbf4e7.js"><link rel="prefetch" href="/assets/js/185.6d852b91.js"><link rel="prefetch" href="/assets/js/186.2739a188.js"><link rel="prefetch" href="/assets/js/187.9828f8e1.js"><link rel="prefetch" href="/assets/js/188.f0104a26.js"><link rel="prefetch" href="/assets/js/189.e141c6b6.js"><link rel="prefetch" href="/assets/js/19.da294525.js"><link rel="prefetch" href="/assets/js/190.c5bce55c.js"><link rel="prefetch" href="/assets/js/191.0a31f2ed.js"><link rel="prefetch" href="/assets/js/192.c99df1ba.js"><link rel="prefetch" href="/assets/js/193.6774c4ab.js"><link rel="prefetch" href="/assets/js/194.7e9c2ccc.js"><link rel="prefetch" href="/assets/js/195.31822c0f.js"><link rel="prefetch" href="/assets/js/196.8ef27177.js"><link rel="prefetch" href="/assets/js/197.95ce2481.js"><link rel="prefetch" href="/assets/js/198.11537ac5.js"><link rel="prefetch" href="/assets/js/199.f87470d6.js"><link rel="prefetch" href="/assets/js/20.f3f361e9.js"><link rel="prefetch" href="/assets/js/200.6dea4b37.js"><link rel="prefetch" href="/assets/js/201.27e2b3af.js"><link rel="prefetch" href="/assets/js/202.5fb57278.js"><link rel="prefetch" href="/assets/js/203.4b197b72.js"><link rel="prefetch" href="/assets/js/204.02083e58.js"><link rel="prefetch" href="/assets/js/205.f5a0f9ac.js"><link rel="prefetch" href="/assets/js/206.44269b20.js"><link rel="prefetch" href="/assets/js/207.5aa0dc4f.js"><link rel="prefetch" href="/assets/js/208.d5e417b1.js"><link rel="prefetch" href="/assets/js/209.cf4f05c4.js"><link rel="prefetch" href="/assets/js/21.69ebcf70.js"><link rel="prefetch" href="/assets/js/210.2b9041fa.js"><link rel="prefetch" href="/assets/js/211.10483086.js"><link rel="prefetch" href="/assets/js/212.3d0dcb3e.js"><link rel="prefetch" href="/assets/js/213.c84eeba9.js"><link rel="prefetch" href="/assets/js/214.ac472bfc.js"><link rel="prefetch" href="/assets/js/215.a457558a.js"><link rel="prefetch" href="/assets/js/216.d04a28e1.js"><link rel="prefetch" href="/assets/js/217.05aba786.js"><link rel="prefetch" href="/assets/js/218.a863c37a.js"><link rel="prefetch" href="/assets/js/219.7dec7421.js"><link rel="prefetch" href="/assets/js/22.d01326e7.js"><link rel="prefetch" href="/assets/js/220.7098fc50.js"><link rel="prefetch" href="/assets/js/221.6ead8a78.js"><link rel="prefetch" href="/assets/js/222.bb4c0e57.js"><link rel="prefetch" href="/assets/js/223.50b992ec.js"><link rel="prefetch" href="/assets/js/224.1e5b111f.js"><link rel="prefetch" href="/assets/js/225.d64e693b.js"><link rel="prefetch" href="/assets/js/226.5d517cf2.js"><link rel="prefetch" href="/assets/js/227.55a331ee.js"><link rel="prefetch" href="/assets/js/228.9128b32d.js"><link rel="prefetch" href="/assets/js/229.5e71e628.js"><link rel="prefetch" href="/assets/js/23.c9bc0ea6.js"><link rel="prefetch" href="/assets/js/230.6daf681f.js"><link rel="prefetch" href="/assets/js/231.b43ff551.js"><link rel="prefetch" href="/assets/js/232.c87810d8.js"><link rel="prefetch" href="/assets/js/233.b5c0e6b1.js"><link rel="prefetch" href="/assets/js/234.50887b03.js"><link rel="prefetch" href="/assets/js/235.e7299edc.js"><link rel="prefetch" href="/assets/js/236.ebc4838d.js"><link rel="prefetch" href="/assets/js/237.f05278b5.js"><link rel="prefetch" href="/assets/js/238.22017696.js"><link rel="prefetch" href="/assets/js/239.eee224df.js"><link rel="prefetch" href="/assets/js/24.145475ae.js"><link rel="prefetch" href="/assets/js/240.2e401eaf.js"><link rel="prefetch" href="/assets/js/241.13b70c68.js"><link rel="prefetch" href="/assets/js/242.a155eb55.js"><link rel="prefetch" href="/assets/js/243.1fc340b4.js"><link rel="prefetch" href="/assets/js/245.ae2221f8.js"><link rel="prefetch" href="/assets/js/246.5b9919b8.js"><link rel="prefetch" href="/assets/js/247.8510f91e.js"><link rel="prefetch" href="/assets/js/248.bb2b74f8.js"><link rel="prefetch" href="/assets/js/249.fce641b2.js"><link rel="prefetch" href="/assets/js/25.6a4f99dc.js"><link rel="prefetch" href="/assets/js/250.e7fe5642.js"><link rel="prefetch" href="/assets/js/251.200e84f1.js"><link rel="prefetch" href="/assets/js/252.504082ac.js"><link rel="prefetch" href="/assets/js/253.b2ae815e.js"><link rel="prefetch" href="/assets/js/254.a659f7ce.js"><link rel="prefetch" href="/assets/js/255.cb8fc0c9.js"><link rel="prefetch" href="/assets/js/256.50ca9726.js"><link rel="prefetch" href="/assets/js/257.312a0b0b.js"><link rel="prefetch" href="/assets/js/258.9436ae0d.js"><link rel="prefetch" href="/assets/js/259.8a73f3eb.js"><link rel="prefetch" href="/assets/js/26.ef2dc4ec.js"><link rel="prefetch" href="/assets/js/260.c175eaaf.js"><link rel="prefetch" href="/assets/js/261.e45d1c45.js"><link rel="prefetch" href="/assets/js/262.2c7af640.js"><link rel="prefetch" href="/assets/js/263.e98803f0.js"><link rel="prefetch" href="/assets/js/264.5e65aaaf.js"><link rel="prefetch" href="/assets/js/265.5907408c.js"><link rel="prefetch" href="/assets/js/266.269625b8.js"><link rel="prefetch" href="/assets/js/267.20596cc8.js"><link rel="prefetch" href="/assets/js/268.08da84d1.js"><link rel="prefetch" href="/assets/js/269.32fb0463.js"><link rel="prefetch" href="/assets/js/27.9f755ce4.js"><link rel="prefetch" href="/assets/js/270.22929897.js"><link rel="prefetch" href="/assets/js/271.38168464.js"><link rel="prefetch" href="/assets/js/272.37b4706e.js"><link rel="prefetch" href="/assets/js/273.8442069e.js"><link rel="prefetch" href="/assets/js/274.916bc83e.js"><link rel="prefetch" href="/assets/js/275.0b5e477c.js"><link rel="prefetch" href="/assets/js/276.a17d2943.js"><link rel="prefetch" href="/assets/js/277.337f4973.js"><link rel="prefetch" href="/assets/js/278.57963423.js"><link rel="prefetch" href="/assets/js/279.55328580.js"><link rel="prefetch" href="/assets/js/28.5583a162.js"><link rel="prefetch" href="/assets/js/280.64dd2a5f.js"><link rel="prefetch" href="/assets/js/281.4891e50c.js"><link rel="prefetch" href="/assets/js/282.846ccf57.js"><link rel="prefetch" href="/assets/js/283.190b6105.js"><link rel="prefetch" href="/assets/js/284.cea8ab39.js"><link rel="prefetch" href="/assets/js/285.9a736ee4.js"><link rel="prefetch" href="/assets/js/286.baf72b59.js"><link rel="prefetch" href="/assets/js/287.7b9ac8dd.js"><link rel="prefetch" href="/assets/js/288.0f2dd7a3.js"><link rel="prefetch" href="/assets/js/289.b8faf276.js"><link rel="prefetch" href="/assets/js/29.17436273.js"><link rel="prefetch" href="/assets/js/290.123070af.js"><link rel="prefetch" href="/assets/js/291.2b401f90.js"><link rel="prefetch" href="/assets/js/292.6db3d5d0.js"><link rel="prefetch" href="/assets/js/293.1d6573c3.js"><link rel="prefetch" href="/assets/js/294.47e4ae72.js"><link rel="prefetch" href="/assets/js/295.7c84000b.js"><link rel="prefetch" href="/assets/js/296.e8e24597.js"><link rel="prefetch" href="/assets/js/297.d7205379.js"><link rel="prefetch" href="/assets/js/298.7e61917d.js"><link rel="prefetch" href="/assets/js/299.74c88473.js"><link rel="prefetch" href="/assets/js/3.603ed79b.js"><link rel="prefetch" href="/assets/js/30.7dd304de.js"><link rel="prefetch" href="/assets/js/300.f37eea58.js"><link rel="prefetch" href="/assets/js/301.4631b290.js"><link rel="prefetch" href="/assets/js/302.9877edfb.js"><link rel="prefetch" href="/assets/js/303.c6e35854.js"><link rel="prefetch" href="/assets/js/304.297a6bbd.js"><link rel="prefetch" href="/assets/js/305.49bdcf78.js"><link rel="prefetch" href="/assets/js/306.911f0032.js"><link rel="prefetch" href="/assets/js/307.8adbd359.js"><link rel="prefetch" href="/assets/js/308.ebd0b400.js"><link rel="prefetch" href="/assets/js/309.c726441c.js"><link rel="prefetch" href="/assets/js/31.a96ccda1.js"><link rel="prefetch" href="/assets/js/310.669832cf.js"><link rel="prefetch" href="/assets/js/311.33592b74.js"><link rel="prefetch" href="/assets/js/312.d69b7693.js"><link rel="prefetch" href="/assets/js/313.4b36a021.js"><link rel="prefetch" href="/assets/js/314.d4443d12.js"><link rel="prefetch" href="/assets/js/315.d3ee6f19.js"><link rel="prefetch" href="/assets/js/316.b3b3b30b.js"><link rel="prefetch" href="/assets/js/317.2d119d0f.js"><link rel="prefetch" href="/assets/js/318.8c778697.js"><link rel="prefetch" href="/assets/js/319.ad4ed96a.js"><link rel="prefetch" href="/assets/js/32.fe3d52fc.js"><link rel="prefetch" href="/assets/js/320.a390410b.js"><link rel="prefetch" href="/assets/js/321.542130c4.js"><link rel="prefetch" href="/assets/js/322.c4267922.js"><link rel="prefetch" href="/assets/js/323.77757be4.js"><link rel="prefetch" href="/assets/js/324.daf16678.js"><link rel="prefetch" href="/assets/js/325.33dd10ae.js"><link rel="prefetch" href="/assets/js/326.c273ffb9.js"><link rel="prefetch" href="/assets/js/327.d23e6c92.js"><link rel="prefetch" href="/assets/js/328.9fe05464.js"><link rel="prefetch" href="/assets/js/329.c2e2bb00.js"><link rel="prefetch" href="/assets/js/33.c9bdef3b.js"><link rel="prefetch" href="/assets/js/330.4d3443cf.js"><link rel="prefetch" href="/assets/js/331.170d76ad.js"><link rel="prefetch" href="/assets/js/332.8b6a821b.js"><link rel="prefetch" href="/assets/js/333.bf67a2fc.js"><link rel="prefetch" href="/assets/js/334.596a18eb.js"><link rel="prefetch" href="/assets/js/335.a144d9c4.js"><link rel="prefetch" href="/assets/js/336.140fa7ac.js"><link rel="prefetch" href="/assets/js/337.919e8915.js"><link rel="prefetch" href="/assets/js/338.27332e1e.js"><link rel="prefetch" href="/assets/js/339.eac69ce5.js"><link rel="prefetch" href="/assets/js/34.26a8ecb0.js"><link rel="prefetch" href="/assets/js/340.1a08a3b4.js"><link rel="prefetch" href="/assets/js/341.dc797dd8.js"><link rel="prefetch" href="/assets/js/342.16d2339b.js"><link rel="prefetch" href="/assets/js/343.75d6c551.js"><link rel="prefetch" href="/assets/js/344.6386e156.js"><link rel="prefetch" href="/assets/js/345.940f5b3b.js"><link rel="prefetch" href="/assets/js/346.a619d052.js"><link rel="prefetch" href="/assets/js/347.8149efc4.js"><link rel="prefetch" href="/assets/js/348.8eeb7d51.js"><link rel="prefetch" href="/assets/js/349.a28ee355.js"><link rel="prefetch" href="/assets/js/35.8f6a0fad.js"><link rel="prefetch" href="/assets/js/350.50195c3e.js"><link rel="prefetch" href="/assets/js/351.53e64236.js"><link rel="prefetch" href="/assets/js/352.ea5ef117.js"><link rel="prefetch" href="/assets/js/353.98d30cc0.js"><link rel="prefetch" href="/assets/js/354.4cfd132b.js"><link rel="prefetch" href="/assets/js/355.9de4bc87.js"><link rel="prefetch" href="/assets/js/356.c5b444a7.js"><link rel="prefetch" href="/assets/js/357.da7119c9.js"><link rel="prefetch" href="/assets/js/358.948388c9.js"><link rel="prefetch" href="/assets/js/359.2e1d41fa.js"><link rel="prefetch" href="/assets/js/36.7d41991d.js"><link rel="prefetch" href="/assets/js/360.17a86acb.js"><link rel="prefetch" href="/assets/js/361.0cb6669b.js"><link rel="prefetch" href="/assets/js/362.6d214fe9.js"><link rel="prefetch" href="/assets/js/363.2c13518a.js"><link rel="prefetch" href="/assets/js/364.4e062cfb.js"><link rel="prefetch" href="/assets/js/365.435947c8.js"><link rel="prefetch" href="/assets/js/366.9f035f7f.js"><link rel="prefetch" href="/assets/js/367.6f203ad0.js"><link rel="prefetch" href="/assets/js/368.c1208f02.js"><link rel="prefetch" href="/assets/js/369.15864d3a.js"><link rel="prefetch" href="/assets/js/37.3e371222.js"><link rel="prefetch" href="/assets/js/370.983a75b7.js"><link rel="prefetch" href="/assets/js/371.2d158a44.js"><link rel="prefetch" href="/assets/js/372.817b00d9.js"><link rel="prefetch" href="/assets/js/373.a3f7e510.js"><link rel="prefetch" href="/assets/js/374.746fb1ea.js"><link rel="prefetch" href="/assets/js/375.203031ea.js"><link rel="prefetch" href="/assets/js/376.5d2b05ed.js"><link rel="prefetch" href="/assets/js/377.5eae4445.js"><link rel="prefetch" href="/assets/js/378.da2ce54c.js"><link rel="prefetch" href="/assets/js/379.f29578ba.js"><link rel="prefetch" href="/assets/js/38.c0738668.js"><link rel="prefetch" href="/assets/js/380.cf3b8b02.js"><link rel="prefetch" href="/assets/js/381.1e0ee15b.js"><link rel="prefetch" href="/assets/js/382.185b5cec.js"><link rel="prefetch" href="/assets/js/383.81a0df08.js"><link rel="prefetch" href="/assets/js/384.030e03d1.js"><link rel="prefetch" href="/assets/js/385.6b594acc.js"><link rel="prefetch" href="/assets/js/386.35988f53.js"><link rel="prefetch" href="/assets/js/387.dfde1fbc.js"><link rel="prefetch" href="/assets/js/388.f01e5e0a.js"><link rel="prefetch" href="/assets/js/389.d7f8a17c.js"><link rel="prefetch" href="/assets/js/39.17804091.js"><link rel="prefetch" href="/assets/js/390.b1af8b30.js"><link rel="prefetch" href="/assets/js/391.e4e66ab0.js"><link rel="prefetch" href="/assets/js/392.57c61410.js"><link rel="prefetch" href="/assets/js/393.a520da83.js"><link rel="prefetch" href="/assets/js/394.8716ca42.js"><link rel="prefetch" href="/assets/js/395.82adb50b.js"><link rel="prefetch" href="/assets/js/396.c164a3d6.js"><link rel="prefetch" href="/assets/js/397.83d39a0b.js"><link rel="prefetch" href="/assets/js/398.79ccdcfd.js"><link rel="prefetch" href="/assets/js/399.6393c09f.js"><link rel="prefetch" href="/assets/js/4.e4aaf14c.js"><link rel="prefetch" href="/assets/js/40.d443fbde.js"><link rel="prefetch" href="/assets/js/400.2d944fc1.js"><link rel="prefetch" href="/assets/js/401.268b80ff.js"><link rel="prefetch" href="/assets/js/402.c0c3f68c.js"><link rel="prefetch" href="/assets/js/403.083e8b2b.js"><link rel="prefetch" href="/assets/js/404.4e6f0b13.js"><link rel="prefetch" href="/assets/js/405.6ca5515f.js"><link rel="prefetch" href="/assets/js/406.1d726e20.js"><link rel="prefetch" href="/assets/js/407.9061341c.js"><link rel="prefetch" href="/assets/js/408.6417c73d.js"><link rel="prefetch" href="/assets/js/409.9644048b.js"><link rel="prefetch" href="/assets/js/41.56da8377.js"><link rel="prefetch" href="/assets/js/410.6e7cae19.js"><link rel="prefetch" href="/assets/js/411.d10d09d7.js"><link rel="prefetch" href="/assets/js/412.cdd43db1.js"><link rel="prefetch" href="/assets/js/413.e11cac0c.js"><link rel="prefetch" href="/assets/js/414.cc0556d4.js"><link rel="prefetch" href="/assets/js/415.aaaabf3a.js"><link rel="prefetch" href="/assets/js/416.9eb606c4.js"><link rel="prefetch" href="/assets/js/417.43b60a6f.js"><link rel="prefetch" href="/assets/js/418.9555d224.js"><link rel="prefetch" href="/assets/js/419.881f0cd0.js"><link rel="prefetch" href="/assets/js/42.aafff920.js"><link rel="prefetch" href="/assets/js/420.4597f87f.js"><link rel="prefetch" href="/assets/js/421.9e2b7c38.js"><link rel="prefetch" href="/assets/js/422.67f0bcd9.js"><link rel="prefetch" href="/assets/js/423.eeee12da.js"><link rel="prefetch" href="/assets/js/424.c0bc7088.js"><link rel="prefetch" href="/assets/js/425.cd9f2cbe.js"><link rel="prefetch" href="/assets/js/426.9ac3c10a.js"><link rel="prefetch" href="/assets/js/427.8a42bc74.js"><link rel="prefetch" href="/assets/js/428.3206e476.js"><link rel="prefetch" href="/assets/js/429.7a741277.js"><link rel="prefetch" href="/assets/js/43.1187d734.js"><link rel="prefetch" href="/assets/js/430.24df4cca.js"><link rel="prefetch" href="/assets/js/431.c874ea4d.js"><link rel="prefetch" href="/assets/js/432.0640ab82.js"><link rel="prefetch" href="/assets/js/433.6fbad864.js"><link rel="prefetch" href="/assets/js/434.058d3ea0.js"><link rel="prefetch" href="/assets/js/435.65681d99.js"><link rel="prefetch" href="/assets/js/436.b736f166.js"><link rel="prefetch" href="/assets/js/437.ce1622f6.js"><link rel="prefetch" href="/assets/js/438.92578ffd.js"><link rel="prefetch" href="/assets/js/439.dc0236aa.js"><link rel="prefetch" href="/assets/js/44.f063c31f.js"><link rel="prefetch" href="/assets/js/440.67f05464.js"><link rel="prefetch" href="/assets/js/441.41b7084f.js"><link rel="prefetch" href="/assets/js/442.f2e3b7e0.js"><link rel="prefetch" href="/assets/js/443.612cc90b.js"><link rel="prefetch" href="/assets/js/444.0b9b4e2d.js"><link rel="prefetch" href="/assets/js/445.afce98d0.js"><link rel="prefetch" href="/assets/js/446.5b24d043.js"><link rel="prefetch" href="/assets/js/447.42ef4c92.js"><link rel="prefetch" href="/assets/js/448.9b46084b.js"><link rel="prefetch" href="/assets/js/449.9d6a3934.js"><link rel="prefetch" href="/assets/js/45.c903ded3.js"><link rel="prefetch" href="/assets/js/450.0f8f9ef2.js"><link rel="prefetch" href="/assets/js/451.8d0f5935.js"><link rel="prefetch" href="/assets/js/452.26fc5a41.js"><link rel="prefetch" href="/assets/js/453.f98793d9.js"><link rel="prefetch" href="/assets/js/454.b16d5353.js"><link rel="prefetch" href="/assets/js/455.b39e4c52.js"><link rel="prefetch" href="/assets/js/456.f4aeb52c.js"><link rel="prefetch" href="/assets/js/457.a0649f7b.js"><link rel="prefetch" href="/assets/js/458.4d5dd48c.js"><link rel="prefetch" href="/assets/js/459.bdece430.js"><link rel="prefetch" href="/assets/js/46.c390d374.js"><link rel="prefetch" href="/assets/js/460.646bea09.js"><link rel="prefetch" href="/assets/js/461.ce90de7c.js"><link rel="prefetch" href="/assets/js/462.e6dc008e.js"><link rel="prefetch" href="/assets/js/463.92b34dc0.js"><link rel="prefetch" href="/assets/js/464.ae9b121d.js"><link rel="prefetch" href="/assets/js/465.ec51a4b2.js"><link rel="prefetch" href="/assets/js/466.53bc2dcc.js"><link rel="prefetch" href="/assets/js/467.4fb2648c.js"><link rel="prefetch" href="/assets/js/468.757de5f7.js"><link rel="prefetch" href="/assets/js/469.bcc63cd3.js"><link rel="prefetch" href="/assets/js/47.08510b62.js"><link rel="prefetch" href="/assets/js/470.79749bfc.js"><link rel="prefetch" href="/assets/js/471.cfcff67a.js"><link rel="prefetch" href="/assets/js/472.0948aca5.js"><link rel="prefetch" href="/assets/js/473.e01f4aee.js"><link rel="prefetch" href="/assets/js/474.e6854bfd.js"><link rel="prefetch" href="/assets/js/475.268482fe.js"><link rel="prefetch" href="/assets/js/476.20285045.js"><link rel="prefetch" href="/assets/js/477.1fb4dc61.js"><link rel="prefetch" href="/assets/js/478.a3befcb9.js"><link rel="prefetch" href="/assets/js/479.c906251d.js"><link rel="prefetch" href="/assets/js/48.4902dab4.js"><link rel="prefetch" href="/assets/js/480.a09cbcb9.js"><link rel="prefetch" href="/assets/js/481.f86acf95.js"><link rel="prefetch" href="/assets/js/482.a183be6b.js"><link rel="prefetch" href="/assets/js/483.2aa9b501.js"><link rel="prefetch" href="/assets/js/484.8f04826f.js"><link rel="prefetch" href="/assets/js/485.85b00ab2.js"><link rel="prefetch" href="/assets/js/486.4135aa3d.js"><link rel="prefetch" href="/assets/js/487.3c6ee63e.js"><link rel="prefetch" href="/assets/js/488.e149dd3f.js"><link rel="prefetch" href="/assets/js/489.6d8d121d.js"><link rel="prefetch" href="/assets/js/49.14ef8da8.js"><link rel="prefetch" href="/assets/js/490.2ed02952.js"><link rel="prefetch" href="/assets/js/491.451fe7ed.js"><link rel="prefetch" href="/assets/js/492.4ab175c3.js"><link rel="prefetch" href="/assets/js/493.df5db673.js"><link rel="prefetch" href="/assets/js/494.9eb3ced5.js"><link rel="prefetch" href="/assets/js/495.846bee9f.js"><link rel="prefetch" href="/assets/js/496.ac45e9d5.js"><link rel="prefetch" href="/assets/js/497.0b0c163b.js"><link rel="prefetch" href="/assets/js/498.7463bdb2.js"><link rel="prefetch" href="/assets/js/499.c8cd2767.js"><link rel="prefetch" href="/assets/js/5.aafe7d58.js"><link rel="prefetch" href="/assets/js/50.b372e073.js"><link rel="prefetch" href="/assets/js/500.a80fe311.js"><link rel="prefetch" href="/assets/js/501.b7f00511.js"><link rel="prefetch" href="/assets/js/502.5efaabdc.js"><link rel="prefetch" href="/assets/js/503.51e33c2d.js"><link rel="prefetch" href="/assets/js/504.443f35c0.js"><link rel="prefetch" href="/assets/js/505.4a3de994.js"><link rel="prefetch" href="/assets/js/506.1c123db3.js"><link rel="prefetch" href="/assets/js/507.80fb39b7.js"><link rel="prefetch" href="/assets/js/508.d9443a53.js"><link rel="prefetch" href="/assets/js/509.1c88dbd4.js"><link rel="prefetch" href="/assets/js/51.00f566d6.js"><link rel="prefetch" href="/assets/js/510.1485b105.js"><link rel="prefetch" href="/assets/js/511.4e61a2b5.js"><link rel="prefetch" href="/assets/js/512.b4a5b219.js"><link rel="prefetch" href="/assets/js/513.859e20ad.js"><link rel="prefetch" href="/assets/js/514.30b0d04b.js"><link rel="prefetch" href="/assets/js/515.756b5645.js"><link rel="prefetch" href="/assets/js/516.f7bd3293.js"><link rel="prefetch" href="/assets/js/517.24283391.js"><link rel="prefetch" href="/assets/js/518.001b3ed2.js"><link rel="prefetch" href="/assets/js/519.f5d6c625.js"><link rel="prefetch" href="/assets/js/52.066b3496.js"><link rel="prefetch" href="/assets/js/520.11c5349e.js"><link rel="prefetch" href="/assets/js/521.fb4740b7.js"><link rel="prefetch" href="/assets/js/522.e4b69bd1.js"><link rel="prefetch" href="/assets/js/523.98800aa4.js"><link rel="prefetch" href="/assets/js/524.cfab6cb1.js"><link rel="prefetch" href="/assets/js/525.37b9611d.js"><link rel="prefetch" href="/assets/js/526.83b6b08c.js"><link rel="prefetch" href="/assets/js/527.a201969f.js"><link rel="prefetch" href="/assets/js/528.3eda9cdf.js"><link rel="prefetch" href="/assets/js/529.a726f1dc.js"><link rel="prefetch" href="/assets/js/53.6291d653.js"><link rel="prefetch" href="/assets/js/530.00956b53.js"><link rel="prefetch" href="/assets/js/531.d66d63a5.js"><link rel="prefetch" href="/assets/js/532.cddb6cf7.js"><link rel="prefetch" href="/assets/js/533.73d794c1.js"><link rel="prefetch" href="/assets/js/534.e70a7255.js"><link rel="prefetch" href="/assets/js/535.39f01763.js"><link rel="prefetch" href="/assets/js/536.6833727e.js"><link rel="prefetch" href="/assets/js/537.65d661b2.js"><link rel="prefetch" href="/assets/js/538.67397168.js"><link rel="prefetch" href="/assets/js/54.939afea0.js"><link rel="prefetch" href="/assets/js/55.3c96f255.js"><link rel="prefetch" href="/assets/js/56.6ea06ced.js"><link rel="prefetch" href="/assets/js/57.3464fb24.js"><link rel="prefetch" href="/assets/js/58.aff223fa.js"><link rel="prefetch" href="/assets/js/59.8ce1d621.js"><link rel="prefetch" href="/assets/js/6.9978857d.js"><link rel="prefetch" href="/assets/js/60.7b4d749c.js"><link rel="prefetch" href="/assets/js/61.efd288e6.js"><link rel="prefetch" href="/assets/js/62.fc1e8c01.js"><link rel="prefetch" href="/assets/js/63.ceeb7571.js"><link rel="prefetch" href="/assets/js/64.5a6f4e3d.js"><link rel="prefetch" href="/assets/js/65.99a885b8.js"><link rel="prefetch" href="/assets/js/66.fa6ed5d3.js"><link rel="prefetch" href="/assets/js/67.7030dbf9.js"><link rel="prefetch" href="/assets/js/68.32ae31b3.js"><link rel="prefetch" href="/assets/js/69.7b62268d.js"><link rel="prefetch" href="/assets/js/7.69dfec51.js"><link rel="prefetch" href="/assets/js/70.c618087b.js"><link rel="prefetch" href="/assets/js/71.e444a4bd.js"><link rel="prefetch" href="/assets/js/72.26dc612f.js"><link rel="prefetch" href="/assets/js/73.0e0b4474.js"><link rel="prefetch" href="/assets/js/74.b68294cf.js"><link rel="prefetch" href="/assets/js/75.7a49d4ca.js"><link rel="prefetch" href="/assets/js/76.b80bd638.js"><link rel="prefetch" href="/assets/js/77.e99e7e1f.js"><link rel="prefetch" href="/assets/js/78.fcce05aa.js"><link rel="prefetch" href="/assets/js/79.eac6fbfa.js"><link rel="prefetch" href="/assets/js/81.384ed42c.js"><link rel="prefetch" href="/assets/js/82.ced9799f.js"><link rel="prefetch" href="/assets/js/83.28b240d6.js"><link rel="prefetch" href="/assets/js/84.aa95c43d.js"><link rel="prefetch" href="/assets/js/85.cbb9d877.js"><link rel="prefetch" href="/assets/js/86.5152e88f.js"><link rel="prefetch" href="/assets/js/87.99919db0.js"><link rel="prefetch" href="/assets/js/88.62766163.js"><link rel="prefetch" href="/assets/js/89.a730909b.js"><link rel="prefetch" href="/assets/js/90.3cca9f0b.js"><link rel="prefetch" href="/assets/js/91.589cc7d6.js"><link rel="prefetch" href="/assets/js/92.5ca84528.js"><link rel="prefetch" href="/assets/js/93.8c12b188.js"><link rel="prefetch" href="/assets/js/94.4525023a.js"><link rel="prefetch" href="/assets/js/95.cc020341.js"><link rel="prefetch" href="/assets/js/96.b7166e2d.js"><link rel="prefetch" href="/assets/js/97.8aabed77.js"><link rel="prefetch" href="/assets/js/98.da74f780.js"><link rel="prefetch" href="/assets/js/99.29b01f0c.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.68ec0790.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7dcbcc26.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="黑豆的博客" class="logo"> <span class="site-name can-hide">黑豆的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://v.douyin.com/xV-8RHTmtUs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  视频
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Vue
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/深入浅出Vue.js/01.html" class="nav-link">
  深入浅出Vue
</a></li><li class="dropdown-subitem"><a href="/front/vue/vue/01.html" class="nav-link">
  Vue
</a></li><li class="dropdown-subitem"><a href="/front/vue/vue-router/01.html" class="nav-link">
  VueRouter
</a></li><li class="dropdown-subitem"><a href="/front/vue/Vuex/01.html" class="nav-link">
  Vuex
</a></li><li class="dropdown-subitem"><a href="/front/vue/vue3/01.html" class="nav-link">
  Vue3核心剖析
</a></li><li class="dropdown-subitem"><a href="/front/vue/Vue知识点简单梳理/01.html" class="nav-link">
  Vue知识点简单梳理
</a></li></ul></li><li class="dropdown-item"><h4>
          React
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/深入React技术栈/01.html" class="nav-link">
  深入React技术栈
</a></li><li class="dropdown-subitem"><a href="/front/react/React进阶实践指南/01.html" class="nav-link">
  React进阶实践指南
</a></li><li class="dropdown-subitem"><a href="/front/react/React知识点简单梳理/01.html" class="nav-link">
  React知识点简单梳理
</a></li></ul></li><li class="dropdown-item"><h4>
          混合开发
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/混合开发/01.html" class="nav-link">
  混合开发探究
</a></li></ul></li><li class="dropdown-item"><h4>
          TypeScript
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/ts/极简入门Typescript/01.html" class="nav-link">
  极简入门Typescript
</a></li></ul></li><li class="dropdown-item"><h4>
          Webpack
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/webpack/极简入门webpack/01.html" class="nav-link">
  极简入门
</a></li><li class="dropdown-subitem"><a href="/front/webpack/常见面试题/01.html" class="nav-link">
  常见面试题
</a></li></ul></li><li class="dropdown-item"><h4>
          设计模式
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/设计模式/JS设计模式核心原理和应用实践/01.html" class="nav-link">
  JS设计模式核心原理和应用实践
</a></li></ul></li><li class="dropdown-item"><h4>
          基础必备
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/base/html必备/01.html" class="nav-link">
  HTML必备
</a></li><li class="dropdown-subitem"><a href="/front/base/CSS必备/01.html" class="nav-link">
  CSS必备
</a></li><li class="dropdown-subitem"><a href="/front/base/JS基础/01.html" class="nav-link">
  JS基础
</a></li><li class="dropdown-subitem"><a href="/front/base/JS进阶/01.html" class="nav-link">
  JS进阶
</a></li><li class="dropdown-subitem"><a href="/front/base/JS练习/01.html" class="nav-link">
  JS练习
</a></li><li class="dropdown-subitem"><a href="/front/base/网络基础/01.html" class="nav-link">
  网络基础
</a></li><li class="dropdown-subitem"><a href="/books/JS高级程序设计/01.html" class="nav-link">
  JS高级程序设计
</a></li><li class="dropdown-subitem"><a href="/front/base/浏览器相关基础/01.html" class="nav-link">
  浏览器相关基础
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Java/JavaBase/01.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-subitem"><a href="/Java/JavaUp/01.html" class="nav-link">
  Java进阶
</a></li><li class="dropdown-subitem"><a href="/Java/JavaWeb/01.html" class="nav-link">
  JavaWeb
</a></li><li class="dropdown-subitem"><a href="/Java/JavaFrame/01.html" class="nav-link">
  Java框架
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front/算法和数据结构/入门级算法/01.html" class="nav-link">
  入门级算法
</a></li><li class="dropdown-item"><!----> <a href="/front/算法和数据结构/常见算法/01.html" class="nav-link">
  常见算法
</a></li><li class="dropdown-item"><!----> <a href="/front/算法和数据结构/常见数据结构/01.html" class="nav-link">
  常见数据结构
</a></li><li class="dropdown-item"><!----> <a href="/front/算法和数据结构/前端算法与数据结构/01.html" class="nav-link">
  前端算法与数据结构
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="电子" class="dropdown-title"><span class="title">电子</span> <span class="arrow down"></span></button> <button type="button" aria-label="电子" class="mobile-dropdown-title"><span class="title">电子</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          STM32
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/电子/STM32四轴飞行器/01.html" class="nav-link">
  STM32四轴飞行器
</a></li></ul></li><li class="dropdown-item"><h4>
          Arduino
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/电子/Arduino墙画机/01.html" class="nav-link">
  Arduino墙画机
</a></li><li class="dropdown-subitem"><a href="/电子/Arduino四轴飞行器/01.html" class="nav-link">
  Arduino四轴飞行器
</a></li><li class="dropdown-subitem"><a href="/电子/Arduino四足仿生机器人/01.html" class="nav-link">
  Arduino四足仿生机器人
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/heidouya" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关于
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://v.douyin.com/xV-8RHTmtUs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  视频
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Vue
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/深入浅出Vue.js/01.html" class="nav-link">
  深入浅出Vue
</a></li><li class="dropdown-subitem"><a href="/front/vue/vue/01.html" class="nav-link">
  Vue
</a></li><li class="dropdown-subitem"><a href="/front/vue/vue-router/01.html" class="nav-link">
  VueRouter
</a></li><li class="dropdown-subitem"><a href="/front/vue/Vuex/01.html" class="nav-link">
  Vuex
</a></li><li class="dropdown-subitem"><a href="/front/vue/vue3/01.html" class="nav-link">
  Vue3核心剖析
</a></li><li class="dropdown-subitem"><a href="/front/vue/Vue知识点简单梳理/01.html" class="nav-link">
  Vue知识点简单梳理
</a></li></ul></li><li class="dropdown-item"><h4>
          React
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/books/深入React技术栈/01.html" class="nav-link">
  深入React技术栈
</a></li><li class="dropdown-subitem"><a href="/front/react/React进阶实践指南/01.html" class="nav-link">
  React进阶实践指南
</a></li><li class="dropdown-subitem"><a href="/front/react/React知识点简单梳理/01.html" class="nav-link">
  React知识点简单梳理
</a></li></ul></li><li class="dropdown-item"><h4>
          混合开发
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/混合开发/01.html" class="nav-link">
  混合开发探究
</a></li></ul></li><li class="dropdown-item"><h4>
          TypeScript
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/ts/极简入门Typescript/01.html" class="nav-link">
  极简入门Typescript
</a></li></ul></li><li class="dropdown-item"><h4>
          Webpack
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/webpack/极简入门webpack/01.html" class="nav-link">
  极简入门
</a></li><li class="dropdown-subitem"><a href="/front/webpack/常见面试题/01.html" class="nav-link">
  常见面试题
</a></li></ul></li><li class="dropdown-item"><h4>
          设计模式
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/设计模式/JS设计模式核心原理和应用实践/01.html" class="nav-link">
  JS设计模式核心原理和应用实践
</a></li></ul></li><li class="dropdown-item"><h4>
          基础必备
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/base/html必备/01.html" class="nav-link">
  HTML必备
</a></li><li class="dropdown-subitem"><a href="/front/base/CSS必备/01.html" class="nav-link">
  CSS必备
</a></li><li class="dropdown-subitem"><a href="/front/base/JS基础/01.html" class="nav-link">
  JS基础
</a></li><li class="dropdown-subitem"><a href="/front/base/JS进阶/01.html" class="nav-link">
  JS进阶
</a></li><li class="dropdown-subitem"><a href="/front/base/JS练习/01.html" class="nav-link">
  JS练习
</a></li><li class="dropdown-subitem"><a href="/front/base/网络基础/01.html" class="nav-link">
  网络基础
</a></li><li class="dropdown-subitem"><a href="/books/JS高级程序设计/01.html" class="nav-link">
  JS高级程序设计
</a></li><li class="dropdown-subitem"><a href="/front/base/浏览器相关基础/01.html" class="nav-link">
  浏览器相关基础
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Java/JavaBase/01.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-subitem"><a href="/Java/JavaUp/01.html" class="nav-link">
  Java进阶
</a></li><li class="dropdown-subitem"><a href="/Java/JavaWeb/01.html" class="nav-link">
  JavaWeb
</a></li><li class="dropdown-subitem"><a href="/Java/JavaFrame/01.html" class="nav-link">
  Java框架
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front/算法和数据结构/入门级算法/01.html" class="nav-link">
  入门级算法
</a></li><li class="dropdown-item"><!----> <a href="/front/算法和数据结构/常见算法/01.html" class="nav-link">
  常见算法
</a></li><li class="dropdown-item"><!----> <a href="/front/算法和数据结构/常见数据结构/01.html" class="nav-link">
  常见数据结构
</a></li><li class="dropdown-item"><!----> <a href="/front/算法和数据结构/前端算法与数据结构/01.html" class="nav-link">
  前端算法与数据结构
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="电子" class="dropdown-title"><span class="title">电子</span> <span class="arrow down"></span></button> <button type="button" aria-label="电子" class="mobile-dropdown-title"><span class="title">电子</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          STM32
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/电子/STM32四轴飞行器/01.html" class="nav-link">
  STM32四轴飞行器
</a></li></ul></li><li class="dropdown-item"><h4>
          Arduino
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/电子/Arduino墙画机/01.html" class="nav-link">
  Arduino墙画机
</a></li><li class="dropdown-subitem"><a href="/电子/Arduino四轴飞行器/01.html" class="nav-link">
  Arduino四轴飞行器
</a></li><li class="dropdown-subitem"><a href="/电子/Arduino四足仿生机器人/01.html" class="nav-link">
  Arduino四足仿生机器人
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/heidouya" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关于
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JS深入</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front/base/JS深入/01.html" class="sidebar-link">简介</a></li><li><a href="/front/base/JS深入/02.html" class="sidebar-link">JS中的数据类型</a></li><li><a href="/front/base/JS深入/03.html" class="sidebar-link">堆栈内存</a></li><li><a href="/front/base/JS深入/04.html" class="sidebar-link">作用域和作用域链</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/base/JS深入/04.html#练习" class="sidebar-link">练习</a></li></ul></li><li><a href="/front/base/JS深入/31.html" class="sidebar-link">JS中this的五种情况</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/base/JS深入/31.html#事件绑定" class="sidebar-link">事件绑定</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/31.html#普通函数执行" class="sidebar-link">普通函数执行</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/31.html#构造函数执行" class="sidebar-link">构造函数执行</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/31.html#箭头函数" class="sidebar-link">箭头函数</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/31.html#call、apply、bind" class="sidebar-link">call、apply、bind</a></li></ul></li><li><a href="/front/base/JS深入/32.html" class="sidebar-link">JS中数据类型检测的四种方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/base/JS深入/32.html#typeof" class="sidebar-link">typeof</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/32.html#instanceof" class="sidebar-link">instanceof</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/32.html#object-prototype-tostring-call" class="sidebar-link">Object.prototype.toString.call</a></li></ul></li><li><a href="/front/base/JS深入/33.html" class="sidebar-link">JS中的继承方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/base/JS深入/33.html#原型继承" class="sidebar-link">原型继承</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/33.html#call继承" class="sidebar-link">call继承</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/33.html#寄生组合继承" class="sidebar-link">寄生组合继承</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/33.html#class实现继承" class="sidebar-link">class实现继承</a></li></ul></li><li><a href="/front/base/JS深入/35.html" class="sidebar-link">高阶函数</a></li><li><a href="/front/base/JS深入/36.html" class="sidebar-link">发布订阅和观察者模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/base/JS深入/36.html#发布订阅和观察者模式" class="sidebar-link">发布订阅和观察者模式</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/36.html#观察者模式" class="sidebar-link">观察者模式</a></li></ul></li><li><a href="/front/base/JS深入/37.html" class="active sidebar-link">Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#promise简介" class="sidebar-link">Promise简介</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#手写promise-简单功能" class="sidebar-link">手写Promise(简单功能)</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#手写promise-异步" class="sidebar-link">手写Promise（异步）</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#手写promise-链式调用" class="sidebar-link">手写Promise（链式调用）</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#promise的状态更改问题" class="sidebar-link">promise的状态更改问题</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#延迟对象的作用" class="sidebar-link">延迟对象的作用</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#catch方法的实现" class="sidebar-link">catch方法的实现</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#resolve和reject方法的区别" class="sidebar-link">resolve和reject方法的区别</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#finally的实现原理" class="sidebar-link">finally的实现原理</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#promisify" class="sidebar-link">promisify</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#promise-all" class="sidebar-link">promise-all</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#promise-race" class="sidebar-link">promise-race</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#中断promise链" class="sidebar-link">中断promise链</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/37.html#promise实战" class="sidebar-link">promise实战</a></li></ul></li><li><a href="/front/base/JS深入/39.html" class="sidebar-link">手写常用方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手写bind函数" class="sidebar-link">手写bind函数</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手写call函数" class="sidebar-link">手写call函数</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手写apply函数" class="sidebar-link">手写apply函数</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手写防抖函数" class="sidebar-link">手写防抖函数</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手写节流函数" class="sidebar-link">手写节流函数</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#实现js中的深拷贝" class="sidebar-link">实现js中的深拷贝</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#实现柯里化函数" class="sidebar-link">实现柯里化函数</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手写一个观察者模式" class="sidebar-link">手写一个观察者模式</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手动实现eventemitter-发布订阅模式" class="sidebar-link">手动实现EventEmitter(发布订阅模式)</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手动实现jsonp" class="sidebar-link">手动实现jsonp</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手动实现new关键字" class="sidebar-link">手动实现new关键字</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手动实现-object-assign" class="sidebar-link">手动实现 Object.assign</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#实现-解析url参数为对象-的函数" class="sidebar-link">实现 解析url参数为对象 的函数</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#js格式化数字-每三位加逗号" class="sidebar-link">js格式化数字(每三位加逗号)</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手写instanceof关键字" class="sidebar-link">手写instanceof关键字</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/39.html#手写数组去重的方法" class="sidebar-link">手写数组去重的方法</a></li></ul></li><li><a href="/front/base/JS深入/41.html" class="sidebar-link">EventLoop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/base/JS深入/41.html#浏览器的进程" class="sidebar-link">浏览器的进程</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/41.html#渲染进程-包含着多个线程" class="sidebar-link">渲染进程（包含着多个线程）</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/41.html#宏任务-微任务" class="sidebar-link">宏任务,微任务</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/41.html#微任务和gui渲染" class="sidebar-link">微任务和GUI渲染</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/41.html#事件任务" class="sidebar-link">事件任务</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/41.html#定时器任务" class="sidebar-link">定时器任务</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/41.html#实战题" class="sidebar-link">实战题</a></li></ul></li><li><a href="/front/base/JS深入/43.html" class="sidebar-link">跨域</a></li><li><a href="/front/base/JS深入/45.html" class="sidebar-link">JS面试题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#null是对象吗-为什么" class="sidebar-link">null是对象吗？为什么？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#_1-tostring-为什么可以调用" class="sidebar-link">'1'.toString()为什么可以调用？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#_0-1-0-2为什么不等于0-3" class="sidebar-link">0.1+0.2为什么不等于0.3？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#手动实现一下instanceof的功能" class="sidebar-link">手动实现一下instanceof的功能</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#object-is和-的区别" class="sidebar-link">Object.is和===的区别？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#结果是什么-为什么" class="sidebar-link">[] == ![]结果是什么？为什么？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#js中类型转换有哪几种" class="sidebar-link">JS中类型转换有哪几种？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#和-有什么区别" class="sidebar-link">== 和 ===有什么区别？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#对象转原始类型是根据什么流程运行的" class="sidebar-link">对象转原始类型是根据什么流程运行的？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#如何让if-a-1-a-2-条件成立" class="sidebar-link">如何让if(a == 1 &amp;&amp; a == 2)条件成立？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#谈谈你对闭包的理解" class="sidebar-link">谈谈你对闭包的理解</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#谈谈你对原型链的理解" class="sidebar-link">谈谈你对原型链的理解</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#js如何实现继承" class="sidebar-link">JS如何实现继承</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#textcontent、innertext和innerhtml的用法以及区别" class="sidebar-link">textContent、innerText和innerHTML的用法以及区别</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#js异步编程有哪些方案-为什么会出现这些方案" class="sidebar-link">JS异步编程有哪些方案？为什么会出现这些方案？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#promise-怎么解决回调地狱问题的" class="sidebar-link">Promise 怎么解决回调地狱问题的？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#为什么promise要引入微任务" class="sidebar-link">为什么Promise要引入微任务？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#promise-如何实现链式调用" class="sidebar-link">Promise 如何实现链式调用</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#谈谈你对生成器以及协程的理解" class="sidebar-link">谈谈你对生成器以及协程的理解</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#如何让-generator-的异步代码按顺序执行完毕" class="sidebar-link">如何让 Generator 的异步代码按顺序执行完毕？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#如何让-generator-的异步代码按顺序执行完毕-2" class="sidebar-link">如何让 Generator 的异步代码按顺序执行完毕？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#解释一下async-await的运行机制" class="sidebar-link">解释一下async/await的运行机制</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#foreach-中用-await-会产生什么问题-怎么解决这个问题" class="sidebar-link">forEach 中用 await 会产生什么问题?怎么解决这个问题？</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#iterator" class="sidebar-link">Iterator</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#foreach的使用注意点" class="sidebar-link">forEach的使用注意点</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#javascript-创建对象的几种方式" class="sidebar-link">JavaScript 创建对象的几种方式?</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/45.html#javascript-继承的几种实现方式" class="sidebar-link">JavaScript 继承的几种实现方式?</a></li></ul></li><li><a href="/front/base/JS深入/46.html" class="sidebar-link">跨域</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front/base/JS深入/46.html#遇到的问题" class="sidebar-link">遇到的问题</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/46.html#手写ajax" class="sidebar-link">手写ajax</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/46.html#基于js实现ajax请求并发请求的控制" class="sidebar-link">基于JS实现Ajax请求并发请求的控制</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/46.html#说下vuex" class="sidebar-link">说下vuex</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/46.html#路由懒加载的原理" class="sidebar-link">路由懒加载的原理</a></li><li class="sidebar-sub-header"><a href="/front/base/JS深入/46.html#性能优化-强缓存、协商缓存-字体icon、小图片base64-强缓存返回200-协商304" class="sidebar-link">性能优化，强缓存、协商缓存 字体icon、小图片base64  强缓存返回200 协商304</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="promise简介"><a href="#promise简介" class="header-anchor">#</a> Promise简介</h2> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener noreferrer">Promise MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://es6.ruanyifeng.com/#docs/promise" target="_blank" rel="noopener noreferrer">Promise 对象<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">Promises/A+官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>这里简单总结下promise的特点，具体使用方法可以参考上面的资料链接，这里不对promise的基本做讲解。</p> <ol><li><p>promise有三个状态：成功态(resolve)、失败态(reject)、等待态(pending)</p></li> <li><p>promise默认执行器是立即执行，下面的函数输出1、2</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment">/* 
输出结果
1
2
*/</span>
</code></pre></div><ol start="3"><li><p>用户自己决定失败的原因和成功的原因  成功和失败也是用户定义的</p></li> <li><p>promise的实例都拥有一个then方法 , 一个参数是成功的回调，另一个失败的回调</p></li> <li><p>如果执行函数时发生了异常也会执行失败逻辑</p></li> <li><p>如果promise一旦成功就不能失败 ， 反过来也是一样的 (只有等待态的时候才能去更改状态)</p></li></ol> <p>以上是我们对promise的一些特性总结，下面我们自己来写个简单的promise</p> <p>看看以下输出结果是什么呢：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 第一题</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token parameter">_</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 第二题</span>
<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 第三题</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第四题</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token operator">=&gt;</span>x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'My Error'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token operator">=&gt;</span>x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>error<span class="token punctuation">)</span>
</code></pre></div><p>输出结果依次为</p> <div class="language- extra-class"><pre class="language-text"><code>第一题 fail
第二题 1、2、3
第三题 2
第四题 2
</code></pre></div><h2 id="手写promise-简单功能"><a href="#手写promise-简单功能" class="header-anchor">#</a> 手写Promise(简单功能)</h2> <p>上面我们已经总结出了Promise的几个特点，并且借助<a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">Promises/A+官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>我们可以尝试写个自己的Promise玩玩</p> <p>回想下自调用自带的Promise的写法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>从上面的代码中可以看出Promise是个类，且在创建的时候传递了一个函数做为参数，传递的这个函数接收两个方法做为参数来改变Promise的状态，new出来的实例可以调用then方法，then方法也接收两个参数，由此可知我们创建的Promise首先得是个类，构造函数的参数得接收一个方法做为参数，且这个方法要立即执行，生成的实例可以调用then方法等等</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// promise的三个状态</span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'REJECTED'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'FULFILLED'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PromiseA</span> <span class="token punctuation">{</span>
  <span class="token comment">// executor，构造函数参数，执行器</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// promise的状态，默认为PENDING</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
    <span class="token comment">// 成功的值</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token comment">// 失败的原因</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 状态为PENDING时状态才可以改变</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 状态为PENDING时状态才可以改变</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 失败</span>
			<span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// promise的then方法</span>
	<span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 状态为FULFILLED</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 状态为REJECTED</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> PromiseA<span class="token punctuation">;</span>
</code></pre></div><p>测试是否成功：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 因为自己写的文件</span>
<span class="token keyword">const</span> PromiseA <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./p1'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PromiseA</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// resolve('ok')</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 输出</span>
<span class="token comment">// ok</span>
<span class="token comment">// fail</span>
</code></pre></div><h2 id="手写promise-异步"><a href="#手写promise-异步" class="header-anchor">#</a> 手写Promise（异步）</h2> <p>上面我们实现了一个简版的promise，并且通过简单的实例测试了是否可用，但是这还差的远，以上只是实现了promise最基本的用法，我们使用promise一般是为了处理异步问题，上面的写法显然还处理不了异步问题，因为可能在调用then方法的时候promise的状态还是pending状态，在咱们自己的promise中then方法我们只处理了成功和失败</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> PromiseA <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./p1'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PromiseA</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>上述代码理论上一秒钟后应该输出ok，但实际上并未得到我们想要的结果，下面我们来解决这个问题。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// promise的三个状态</span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'REJECTED'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'FULFILLED'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PromiseA</span> <span class="token punctuation">{</span>
  <span class="token comment">// executor，构造函数参数，执行器</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// promise的状态，默认为PENDING</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
    <span class="token comment">// 成功的值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token comment">// 失败的原因</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

    <span class="token comment">// 成功和失败的回调之所以用数组存放是因为then方法可以被调用多次，如果then被调用多次后promise的状态依然为pending状态，then里面的成功和失败方法应被暂存起来，等到promise状态变化后依次执行</span>
		<span class="token comment">// 存放成功的回调</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// 存放失败的回调</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 状态为PENDING时状态才可以改变</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        <span class="token comment">// 当状态变为FULFILLED，依次执行成功的方法</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 状态为PENDING时状态才可以改变</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        <span class="token comment">// 当状态变为REJECTED，依次执行失败的方法</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 失败</span>
			<span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 当调用then方法的时候状态为PENDING状态，先将成功和失败的方法暂时存放起来，等到状态改变后依次调用</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> PromiseA<span class="token punctuation">;</span>
</code></pre></div><p>测试所写功能是否生效</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> PromiseA <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./p1'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PromiseA</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>一秒钟后成功输出了ok</p> <h2 id="手写promise-链式调用"><a href="#手写promise-链式调用" class="header-anchor">#</a> 手写Promise（链式调用）</h2> <p>异步方法无法通过try...catch捕获错误</p> <p>上面我们实现了promise最基本的功能和处理异步的功能，但是有事我们会向下面这样使用promise</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 100</span>
  <span class="token keyword">return</span> <span class="token number">200</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> p3 <span class="token operator">=</span> p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 200</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> p4 <span class="token operator">=</span> p3<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p4<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// err</span>
</code></pre></div><p>上面写的代码没法实现这种链式调用，下面咱们来实现链式调用功能。写之前咱们还是先分析下p2为什么可以调用then方法，只有可能p2也是Promise的实例才可以调用then方法，那它是不是当前的promise实例呢？</p> <p>显然不是，因为p1已经成功了状态不能再改变，但当p3抛出错误后，依然会被捕获到错误，p3的状态还是可变的，所以分析得p3是一个新的promise，而且是当p1调用then方法后返回的一个promise。</p> <p>调用p2的then方法，输出p1.then方法中返回的200，这个是怎么做到的呢？我们知道p1的then方法能输出100是因为调用了resolve方法，所以只要调用p2的resolve方法就可以拿到200了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'REJECTED'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'FULFILLED'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PromiseA</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

		<span class="token comment">// 存放成功的回调</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// 存放失败的回调</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 1. promise 成功和失败的回调的返回值 可以传递到外层的下一个then</span>
  <span class="token comment">// 2. 如果返回的是普通值的话 (传递到下一次的成功中,不是错误不是promise就是普通值) ，出错的情况(一定会走到下一次的失败),可能还要promise的情况(会采用promise的状态，决定走下一次的成功还是失败 )</span>
  <span class="token comment">// 3. 错误处理 如果离自己最近的then 没有错误处理(没有写错误函数) 会向下找</span>
  <span class="token comment">// 4. 每次执行完promise.then方法后返回的都是一个“新的promise&quot; (promisey一旦成功或者失败就不能修改状态)</span>
	<span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 为了实现链式调用，每次执行完promise.then方法后返回的都是一个“新的promise&quot; (因为promisey一旦成功或者失败就不能修改状态，所以不能返回this)</span>
    <span class="token keyword">const</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果失败的话，失败的返回值要传到下一个promise的的成功中</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> promise2
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> PromiseA<span class="token punctuation">;</span>
</code></pre></div><p>正常情况下我们会向下面这样使用promise</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 伪代码获取新闻详情内容和推荐列表</span>
<span class="token keyword">function</span> <span class="token function">getNewsDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">getNewsDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 假设先获取新闻详情内容id，通过内容id获取相关的新闻</span>
  <span class="token keyword">return</span> <span class="token function">fetchList</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>返回的不再是个普通值而是promise的情况，我们改怎么办呢？promise2状态的处理、promise2和x引用同一变量</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'REJECTED'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'FULFILLED'</span><span class="token punctuation">;</span>

<span class="token comment">// x决定p2是成功还是失败</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// console.log('promise2',promise2, 'x',x, 'resolve',resolve, 'reject',reject)</span>

  <span class="token comment">// 循环引用，自己等待自己完成，错误的实现用于解决下面这种问题</span>
  <span class="token comment">/* 
  const p = new Promise((resolve, reject) =&gt; {
    resolve(100)
  })

  const p2 = p.then(_=&gt;p2)
  p2.then(res=&gt;console.log('res', res), err=&gt;console.log('err', err))
  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise2 <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 用一个类型错误结束调promise </span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected for promise'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 后续的代码要严格判断，保证代码能和别的库一起使用如bluebird、es6-promise</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PromiseA</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

		<span class="token comment">// 存放成功的回调</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// 存放失败的回调</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 1. promise 成功和失败的回调的返回值 可以传递到外层的下一个then</span>
  <span class="token comment">// 2. 如果返回的是普通值的话 (传递到下一次的成功中,不是错误不是promise就是普通值) ，出错的情况(一定会走到下一次的失败),可能还要promise的情况(会采用promise的状态，决定走下一次的成功还是失败 )</span>
  <span class="token comment">// 3. 错误处理 如果离自己最近的then 没有错误处理(没有写错误函数) 会向下找</span>
  <span class="token comment">// 4. 每次执行完promise.then方法后返回的都是一个“新的promise&quot; (promisey一旦成功或者失败就不能修改状态)</span>
	<span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 为了实现链式调用，每次执行完promise.then方法后返回的都是一个“新的promise&quot; (因为promisey一旦成功或者失败就不能修改状态，所以不能返回this)</span>
    <span class="token keyword">const</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PromiseA</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// const x = onFulfilled(this.value)</span>
        <span class="token comment">//  直接这样取拿不到promise2，因为new PromiseA()内部代码还没执行完，拿不到promise2，需要使用定时器</span>
        <span class="token comment">// resolvePromise(promise2, x, resolve, reject)</span>


        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 因为异步调用了onFulfilled，如果发生错误try...catch捕获不到，需要再写一个try...catch</span>
          <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// const x = onRejected(this.reason);</span>
        <span class="token comment">// 如果失败的话，失败的返回值要传到下一个promise的的成功中</span>
        <span class="token comment">// resolve(x)</span>

        <span class="token comment">// resolvePromise(promise2, x, resolve, reject)</span>
        

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// const x = onFulfilled(this.value);</span>
          <span class="token comment">// resolve(x)</span>
          <span class="token comment">// resolvePromise(promise2, x, resolve, reject)</span>
          
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
              <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// const x = onRejected(this.reason);</span>
          <span class="token comment">// resolve(x)</span>
          <span class="token comment">// resolvePromise(promise2, x, resolve, reject)</span>
          
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
              <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> promise2
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> PromiseA<span class="token punctuation">;</span>
</code></pre></div><h2 id="promise的状态更改问题"><a href="#promise的状态更改问题" class="header-anchor">#</a> promise的状态更改问题</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'REJECTED'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'FULFILLED'</span><span class="token punctuation">;</span>

<span class="token comment">// x决定p2是成功还是失败，这块主要还是为了处理返回的是promise问题</span>
<span class="token comment">/* 
const p = new Promise((resolve, reject) =&gt; {
  resolve(100)
})

const p2 = p.then(()=&gt;{
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      reject('err')
    }, 2000);
  })
})

p2.then(data =&gt; console.log('data', data), err =&gt; console.log('fail', err))
*/</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// console.log('promise2',promise2, 'x',x, 'resolve',resolve, 'reject',reject)</span>

  <span class="token comment">// 循环引用，自己等待自己完成，错误的实现用于解决下面这种问题</span>
  <span class="token comment">/* 
  const p = new Promise((resolve, reject) =&gt; {
    resolve(100)
  })

  const p2 = p.then(_=&gt;p2)
  p2.then(res=&gt;console.log('res', res), err=&gt;console.log('err', err))
  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise2 <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 用一个类型错误结束调promise </span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected for promise'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 后续的代码要严格判断，保证代码能和别的库一起使用如bluebird、es6-promise</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> called
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> x <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 有可能是一个promise</span>

    <span class="token keyword">try</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 只能认为是promise了</span>
        <span class="token comment">// 不要写成x.then 直接then.call就可以了，因为x.then会再次取值，有可能会报错</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token comment">// 根据promise的状态决定成功还是失败</span>
          x<span class="token punctuation">,</span>
          <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// resolve(y)</span>

            <span class="token comment">// 解决问题：</span>
            <span class="token comment">/* 
            const p = new Promise((resolve, reject) =&gt; {
              resolve(100)
            })

            const p2 = p.then(()=&gt;{
              return new Promise((resolve, reject) =&gt; {
                setTimeout(() =&gt; {
                  resolve(new Promise((resolve, reject) =&gt; {
                    setTimeout(() =&gt; {
                      resolve('ok')
                    }, 2000);
                  }))
                }, 2000);
              })
            })

            p2.then(data =&gt; console.log('data', data), err =&gt; console.log('fail', err))
            */</span>

            <span class="token comment">// resolvePromise(promise2, y, resolve, reject) //递归解析过程</span>
            
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span><span class="token keyword">return</span>
            called <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token comment">//递归解析过程</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span><span class="token keyword">return</span>
            called <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 防止失败了再走成功，主要为了防止调用的其他库的promise走了成功还走失败</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span><span class="token keyword">return</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token comment">// 取值出错</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

		<span class="token comment">// 存放成功的回调</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// 存放失败的回调</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 1. promise 成功和失败的回调的返回值 可以传递到外层的下一个then</span>
  <span class="token comment">// 2. 如果返回的是普通值的话 (传递到下一次的成功中,不是错误不是promise就是普通值) ，出错的情况(一定会走到下一次的失败),可能还要promise的情况(会采用promise的状态，决定走下一次的成功还是失败 )</span>
  <span class="token comment">// 3. 错误处理 如果离自己最近的then 没有错误处理(没有写错误函数) 会向下找</span>
  <span class="token comment">// 4. 每次执行完promise.then方法后返回的都是一个“新的promise&quot; (promisey一旦成功或者失败就不能修改状态)</span>
	<span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    const p = new Promise((resolve, reject) =&gt; {
      resolve(1)  
    })

    // 值的穿透
    p.then().then().then(res=&gt;console.log('res===&gt;&gt;', res), err=&gt;console.log('err', err)) // 1
    */</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">v</span><span class="token operator">=&gt;</span>v
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token keyword">throw</span> err<span class="token punctuation">}</span>


    <span class="token comment">// 为了实现链式调用，每次执行完promise.then方法后返回的都是一个“新的promise&quot; (因为promisey一旦成功或者失败就不能修改状态，所以不能返回this)</span>
    <span class="token keyword">const</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// const x = onFulfilled(this.value)</span>
        <span class="token comment">//  直接这样取拿不到promise2，因为new Promise()内部代码还没执行完，拿不到promise2，需要使用定时器</span>
        <span class="token comment">// resolvePromise(promise2, x, resolve, reject)</span>


        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 因为异步调用了onFulfilled，如果发生错误try...catch捕获不到，需要再写一个try...catch</span>
          <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// const x = onRejected(this.reason);</span>
        <span class="token comment">// 如果失败的话，失败的返回值要传到下一个promise的的成功中</span>
        <span class="token comment">// resolve(x)</span>

        <span class="token comment">// resolvePromise(promise2, x, resolve, reject)</span>
        

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// const x = onFulfilled(this.value);</span>
          <span class="token comment">// resolve(x)</span>
          <span class="token comment">// resolvePromise(promise2, x, resolve, reject)</span>
          
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
              <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// const x = onRejected(this.reason);</span>
          <span class="token comment">// resolve(x)</span>
          <span class="token comment">// resolvePromise(promise2, x, resolve, reject)</span>
          
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
              <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> promise2
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 规范测试</span>
Promise<span class="token punctuation">.</span>defer <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dfd <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  dfd<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dfd<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve
      dfd<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> dfd
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise<span class="token punctuation">;</span>
</code></pre></div><p>安装<code>promises-aplus-tests</code></p> <div class="language-js extra-class"><pre class="language-js"><code>npm install promises<span class="token operator">-</span>aplus<span class="token operator">-</span>tests <span class="token operator">-</span><span class="token constant">D</span>
</code></pre></div><p>终端执行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// promise.js文件是自己写的promise代码</span>
npx promises<span class="token operator">-</span>aplus<span class="token operator">-</span>tests promise<span class="token punctuation">.</span>js
</code></pre></div><p>如果输出没有错误说明检查通过，所写代码符合promise规范</p> <h2 id="延迟对象的作用"><a href="#延迟对象的作用" class="header-anchor">#</a> 延迟对象的作用</h2> <p>上述代码中这块代码有什么用呢？</p> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span>defer <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dfd <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  dfd<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dfd<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve
      dfd<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> dfd 
<span class="token punctuation">}</span>
</code></pre></div><p>延迟对象的作用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./p7'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">fileName</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> dfd<span class="token punctuation">.</span>promise
<span class="token punctuation">}</span>
<span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'11.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>上述代码我们给fs.readFile包了异常Promise，如果感觉不好看，可
以用延迟对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./p7'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">fileName</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> dfd <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> dfd<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    dfd<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> dfd<span class="token punctuation">.</span>promise
<span class="token punctuation">}</span>
<span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'11.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="catch方法的实现"><a href="#catch方法的实现" class="header-anchor">#</a> catch方法的实现</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">)</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>我们可以借助then方法来实现catch方法，上述代码捕获错误我们用的是then方法，假设我们给then方法的第一参数传null，然后返回这个then方法是不是可以呢</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span> 
  <span class="token function">catch</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> cb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="resolve和reject方法的区别"><a href="#resolve和reject方法的区别" class="header-anchor">#</a> resolve和reject方法的区别</h2> <p>解决这种问题</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span> 
  <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">reject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这种问题的话上面的代码解决不了</p> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>应该输出ok但使用咱们自己的写的promise输出的是是一个promise对象，怎么解决这个这个问题？</p> <p>要想解决这个问题，首先得分析下原因，为啥会输出一个promise对象呢？</p> <p>是因为将一个new Promise(...)当成了一个参数，传给了咱们自己写的Promise的静态方法resolve</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法又调用了咱们源码中写的resolve方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>将new Promise(...)传递给了value</p> <p>改为</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断value是不是promise</span>
<span class="token operator">+</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 递归解析直到value是给普通值</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallBacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>resolve会等待里面的promise执行完毕，reject不会等待</p> <h2 id="finally的实现原理"><a href="#finally的实现原理" class="header-anchor">#</a> finally的实现原理</h2> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'1000'</span><span class="token punctuation">)</span>
      <span class="token comment">// reject('err')</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>finally 无论如何都会执行，如果finally返回的是一个promise，会等待这个promise执行完，如果是失败的promise会用它失败的原因传给下一个promise</p> <p>我们来实现finally方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token function">finally</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./promise'</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这样会有问题，日志输出了1000，应该输出100</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>将finally做如下修改</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token function">finally</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token operator">=&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token keyword">throw</span> reason<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="promisify"><a href="#promisify" class="header-anchor">#</a> promisify</h2> <p>将node api快速转换成promise方法</p> <p>举例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promises
</code></pre></div><p>promises是一个实验性的语法，可以使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> readFile <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span>

<span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>promisify是怎么实现的呢</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">promisify</span> <span class="token operator">=</span> <span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="promise-all"><a href="#promise-all" class="header-anchor">#</a> promise-all</h2> <p>代码实现</p> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      arr<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data 
      
      <span class="token comment">// 不能使用数组的长度来计算，下面这样写会出错</span>
      <span class="token comment">// if (arr.length === promises.length) {</span>
      <span class="token comment">//   resolve(arr)</span>
      <span class="token comment">// }</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">isPromise</span> <span class="token operator">=</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> val<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span>

    promises <span class="token operator">&amp;&amp;</span> promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token function">handleData</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">handleData</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> promise<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//测试</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./promise'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promises

Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'11.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'11.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="promise-race"><a href="#promise-race" class="header-anchor">#</a> promise-race</h2> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">isPromise</span> <span class="token operator">=</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> val<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span>

    promises <span class="token operator">&amp;&amp;</span> promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">promise</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="中断promise链"><a href="#中断promise链" class="header-anchor">#</a> 中断promise链</h2> <p>需求：一个promise正在走向成功，如果超过2s就认为失败了</p> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">isPromise</span> <span class="token operator">=</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> val<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span>

    promises <span class="token operator">&amp;&amp;</span> promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">promise</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token parameter">promise</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> abort
  <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    abort <span class="token operator">=</span> reject
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>promise<span class="token punctuation">,</span> p<span class="token punctuation">]</span><span class="token punctuation">)</span>
  p1<span class="token punctuation">.</span>abort <span class="token operator">=</span> abort
  <span class="token keyword">return</span> p1
<span class="token punctuation">}</span>

<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'接口请求成功'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token keyword">const</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  p1<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token string">'请求超时'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>中断promise链</p> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res===&gt;&gt;'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="generator"><a href="#generator" class="header-anchor">#</a> generator</h3> <p>generator生成器 =》 遍历器（需要一个next方法） 数组 =》 类数组（长的像数组）</p> <p>generator函数是es6语法，如果碰到yield会暂停执行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span>
  <span class="token keyword">yield</span> <span class="token number">2</span>
  <span class="token keyword">yield</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> it <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// console.log(it.next())</span>
<span class="token comment">// console.log(it.next())</span>
<span class="token comment">// console.log(it.next())</span>
  
<span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  flag <span class="token operator">=</span> done
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>初步使用，执行顺序</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">2</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">3</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> c
<span class="token punctuation">}</span>
<span class="token comment">// 蛇形执行，除了第一次执行的next方法，都是把next中的参数传递给上一次的yield返回结果</span>
<span class="token keyword">const</span> it <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 第一次的next传递参数没有任何意义</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>
</code></pre></div><p><code>[...arr]</code>原理就是遍历这个对象，将结果放到数组中，这个数据必须得有个遍历器</p> <p>将类数组转化为数组的两种方式：</p> <ol><li>Array.from</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> likeArray <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>likeArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 'a', 'b', 'c' ]</span>

<span class="token comment">// 使用Array.from转换数组时不能类数组必须有length属性，否则会返回空数组</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// []</span>
</code></pre></div><ol start="2"><li>遍历器</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> likeArray <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span>
likeArray<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// return {value: 1, done: true}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> i<span class="token operator">++</span> <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>likeArray<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// [ 'a', 'b', 'c' ]</span>
</code></pre></div><p>上面使用遍历器的方法代码看着相对麻烦些，我们可以使用generator</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> likeArray <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span>

<span class="token comment">//注意： * 和yiled必须同时才有效</span>
likeArray<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>likeArray<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// [ 'a', 'b', 'c' ]</span>
</code></pre></div><h3 id="co库"><a href="#co库" class="header-anchor">#</a> co库</h3> <p>使用read</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promises
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">yield</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'name.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token keyword">yield</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> age
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> it <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// const { value, done } = it.next(res)</span>
    <span class="token comment">// console.log('value', value)</span>

    it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">'发生错误啦'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这样的使用明显麻烦，如果有多个promise就需要then多次</p> <p>模拟co库</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promises
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">co</span> <span class="token operator">=</span> <span class="token parameter">it</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 异步迭代的是回调函数</span>
    <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">yield</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'name.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token keyword">yield</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> age
<span class="token punctuation">}</span>

<span class="token function">co</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="promise实战"><a href="#promise实战" class="header-anchor">#</a> promise实战</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'外部promise'</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'外部第一个then'</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'内部promise'</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'内部第一个then'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'内部第二个then'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'外部第二个then'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'外部第三个then'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'外部第四个then'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>浏览器输出结果</p> <div class="language-js extra-class"><pre class="language-js"><code>外部promise
外部第一个then
内部promise
内部第一个then
外部第二个then
外部第三个then
外部第四个then
内部第二个then
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>输出结果</p> <div class="language- extra-class"><pre class="language-text"><code>0
1
2
3
4
5
6
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/front/base/JS深入/36.html" class="prev">
        发布订阅和观察者模式
      </a></span> <span class="next"><a href="/front/base/JS深入/39.html">
        手写常用方法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.99d8b2e7.js" defer></script><script src="/assets/js/2.3eedf0cf.js" defer></script><script src="/assets/js/1.461a0297.js" defer></script><script src="/assets/js/244.6baa3c2c.js" defer></script><script src="/assets/js/80.57c199e7.js" defer></script>
  </body>
</html>
